# Развертывание коммутируемой сети с резервными каналами

### Топология
![](https://github.com/devops-user/otus/blob/main/homeworks_prof/homework_03/images/topo.png)

### Таблица адресации
| Устройство | Интерфейс | IP-адрес | Маска подсети |
--- | --- | --- | --- |
| S1 | VLAN 1 | 192.168.1.1 | 255.255.255.0 |
| S2 | VLAN 1 | 192.168.1.2 | 255.255.255.0 |
| S3 | VLAN 1 | 192.168.1.3 | 255.255.255.0 |

# Создание сети и настройка основных параметров устройства
1. Создадим сеть согласно топологии.
2. Настроим базовые параметры каждого коммутатора, как показано на рисунке ниже.
![](https://github.com/devops-user/otus/blob/main/homeworks_prof/homework_03/images/S1_cfg.png)
![](https://github.com/devops-user/otus/blob/main/homeworks_prof/homework_03/images/S2_cfg.png)
![](https://github.com/devops-user/otus/blob/main/homeworks_prof/homework_03/images/S3_cfg.png)
3. Проверка связи.
  * Успешно ли выполняется эхо-запрос от коммутатора S1 на коммутатор S2?	- *Да*
  * Успешно ли выполняется эхо-запрос от коммутатора S1 на коммутатор S3?	- *Да*
![](https://github.com/devops-user/otus/blob/main/homeworks_prof/homework_03/images/ping_S1.png)
  * Успешно ли выполняется эхо-запрос от коммутатора S2 на коммутатор S3?	- *Да*
![](https://github.com/devops-user/otus/blob/main/homeworks_prof/homework_03/images/ping_S2.png)

# Определение корневого моста
1. Отключим все порты на коммутаторах.
2. Настроим подключенные порты в качестве транковых.
3. Включим порты F0/2 и F0/4 на всех коммутаторах.
4. Отобразим данные протокола **spanning-tree** на каждом коммутаторе, как показано на рисунке ниже.
![](https://github.com/devops-user/otus/blob/main/homeworks_prof/homework_03/images/S1_stp.png)
![](https://github.com/devops-user/otus/blob/main/homeworks_prof/homework_03/images/S2_stp.png)
![](https://github.com/devops-user/otus/blob/main/homeworks_prof/homework_03/images/S3_stp.png)
5. В схему ниже запишем роль и состояние (Sts) активных портов на каждом коммутаторе в топологии.
![](https://github.com/devops-user/otus/blob/main/homeworks_prof/homework_03/images/topo_2.png)

С учетом выходных данных, поступающих с коммутаторов, ответим на следующие вопросы.
  * Какой коммутатор является корневым мостом?
    * - коммутатор S2;
  * Почему этот коммутатор был выбран протоколом **spanning-tree** в качестве корневого моста?
    * - т.к. приориты(Priority) по-умолчанию у всех коммутаторов одинаковые (параметр Priority состоит из Bridge Priority + Sys Ext ID + Main MAC), то следующим фактором идет Main MAC-адрес коммутатора, у S2 он наименьший по сравнению с остальными.
  * Какие порты на коммутаторе являются корневыми портами?
    * - на коммутаторе S1 порт Fa0/4 - являются корневыми портом;
    * - на коммутаторе S2 нет корневых портов;
    * - на коммутаторе S3 порт Fa0/4 - являются корневыми портом;
  * Какие порты на коммутаторе являются назначенными портами?
    * - на коммутаторе S1 порт Fa0/2, являются назначенным портом;
    * - на коммутаторе S2 порты Fa0/2 и Fa0/4, являются назначенными портами;
    * - на коммутаторе S3 нет назначенных портов;
  * Какой порт отображается в качестве альтернативного и в настоящее время заблокирован?
    * - на коммутаторе S3 порт Fa0/2, отображается в качестве альтернативного и в настоящее время заблокирован;
  * Почему протокол **spanning-tree** выбрал этот порт в качестве невыделенного (заблокированного) порта?
    * - т.к у него меньше Bridge ID, в протоколе **spanning-tree** для назначения роли порту используется алгоритм:
        1) Минимальный Root Path Cost (RPC)
        2) Минимальный Bridge ID (Bridge Priority + SysExtID + Main MAC) соседа
        3) Минимальный Port Identifier (Port Priority + PortID) соседа


#	Наблюдение за процессом выбора протоколом STP порта, исходя из стоимости портов
1. Определим коммутатор с заблокированным портом.
  * В нашей топологии это коммутатор - S3
![](https://github.com/devops-user/otus/blob/main/homeworks_prof/homework_03/images/S3_stp.png)
2. Изменим стоимость порта, как показано на рисунке.
![](https://github.com/devops-user/otus/blob/main/homeworks_prof/homework_03/images/S3_cost.png)
3. Просмотрим изменения протокола **spanning-tree**, как показано на рисунке.
![](https://github.com/devops-user/otus/blob/main/homeworks_prof/homework_03/images/S3_cost_2.png)
4. Удалим изменения стоимости порта, как показано на рисунке.
![](https://github.com/devops-user/otus/blob/main/homeworks_prof/homework_03/images/S3_cost_3.png)
  * В протоколе **spanning-tree** для назначения роли порту используется алгоритм, т.к. мы изменили Root Path Cost порта на меньшее значение, чем был по-умолчания, изменилось состояние портов, согласно алгоритма выбора портов:
    1) Минимальный Root Path Cost (RPC)
    2) Минимальный Bridge ID (Bridge Priority + SysExtID + Main MAC) соседа
    3) Минимальный Port Identifier (Port Priority + PortID) соседа

# Наблюдение за процессом выбора протоколом STP порта, исходя из приоритета портов
1. Включим порты Fa0/1 и Fa0/3 на всех коммутаторах.
2. Выполним команду **show spanning-tree** на коммутаторах некорневого моста, как показано на рисунке.
![](https://github.com/devops-user/otus/blob/main/homeworks_prof/homework_03/images/S3_cost_4.png)
![](https://github.com/devops-user/otus/blob/main/homeworks_prof/homework_03/images/S1_cost.png)  
После того, как коммутаторы выбрали Root Bridge, каждый из остальных свичей должен найти один, который будет вести к корневому коммутатору. Такой порт называется корневым портом - Root port. Чтобы понять, какой порт лучше использовать, каждый некорневой коммутатор определяет стоимость маршрута от каждого своего порта до корневого коммутатора. Эта стоимость определяется суммой стоимостей всех линков, которые нужно пройти кадру, чтобы дойти до корневого коммутатора. Если одинаковые стоимости одинаковые, то корневым выбирается меньший порт.
Далее выбираются назначенные (Designated) порты. Из каждого конкретного сегмента сети должен существовать только один путь по направлению к корневому коммутатору.
Опять же согласно алгоритму выбора портов описанному выше:
  

# Вопросы для повторения
1. Какое значение протокол STP использует первым после выбора корневого моста, чтобы определить выбор порта?
   * Порт с более низкой стоимостью пути является предпочтительным
2. Если первое значение на двух портах одинаково, какое следующее значение будет использовать протокол STP при выборе порта?
   * Сравнивется параметр **Bridge ID**
3. Если оба значения на двух портах равны, каким будет следующее значение, которое использует протокол STP при выборе порта?
   * Сравниваются **Port Identity**, это параметр состоит из настраиваемого *Port Priority* и как *номера порта*.
